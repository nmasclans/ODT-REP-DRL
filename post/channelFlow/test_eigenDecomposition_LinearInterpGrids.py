import matplotlib.pyplot as plt
import numpy as np

# ---------- Parameters -----------

# --- Location of Barycentric map corners ---
x1c = np.array( [ 1.0 , 0.0 ] )
x2c = np.array( [ 0.0 , 0.0 ] )
x3c = np.array( [ 0.5 , np.sqrt(3.0)/2.0 ] )

# --- Kronecker delta ---
Deltaij = np.array([[1.0, 0.0, 0.0],
                    [0.0, 1.0, 0.0],
                    [0.0, 0.0, 1.0]])

# ---------------------------------------------------------------
#                           Rij --> xmap
# ---------------------------------------------------------------

# ---------- Define random reynolds stress tensor Rij:
Rij = np.array([[0.758, -0.504, -0.504], 
                [-0.504, 0.107, 0.107], 
                [-0.504, 0.107, 0.107]])

# ---------- Calculate anisotropy tensor Aij:
Rkk = Rij[0,0] + Rij[1,1] + Rij[2,2]
Aij = (1/Rkk) * Rij - (1.0/3.0) * Deltaij
# -> ensure it is trace-free
Akk = Aij[0,0] + Aij[1,1] + Aij[2,2]
for k in range(3):
    Aij[k,k] -= Akk/3.0

# ---------- Calculate eigenvectors and eigenvalues
eigenvalues_a_ij, eigenvectors_a_ij = np.linalg.eigh( Aij )
# -> Sort eigenvalues and eigenvectors in decreasing order, so that eigval_1 >= eigval_2 >= eigval_3
idx = eigenvalues_a_ij.argsort()[::-1]   
eigenvalues_a_ij  = eigenvalues_a_ij[idx]
eigenvectors_a_ij = eigenvectors_a_ij[:,idx]

# ---------- Map eigenvalues to barycentric map
bar_map_xy =   x1c * (     eigenvalues_a_ij[0] -     eigenvalues_a_ij[1])  \
             + x2c * ( 2 * eigenvalues_a_ij[1] - 2 * eigenvalues_a_ij[2]) \
             + x3c * ( 3 * eigenvalues_a_ij[2] + 1)

# ---------------------------------------------------------------
#                           xmap --> Rij
# ---------------------------------------------------------------

# Based on ODT equations:
# -> b (independent term)
b = x3c
# -> B (mapping)
B = np.zeros((2,2))
B[:,0] =   x1c[:] + 2 * x2c[:] - 3 * x3c[:]
B[:,1] = - x1c[:] + 4 * x2c[:] - 3 * x3c[:]
# -> B determinant
Bdet = B[0,0] * B[1,1] - B[0,1] * B[1,0]
# -> B inverse (inverse mapping)
Binv      = np.zeros((2,2))
Binv[0,0] =   B[1,1] / Bdet
Binv[0,1] = - B[0,1] / Bdet
Binv[1,0] = - B[1,0] / Bdet
Binv[1,1] =   B[0,0] / Bdet

xmap_target = np.array([0.5, 0.0])

# ---------- Matrix reconstruction from eigendecomposition matrices

# ---------- Inverse mapping
#  -> Diagonal matrix of eigenvalues
eigenvalues_a_ij_rec  = np.zeros(3)
eigenvalues_a_ij_target_rec  = np.zeros(3)
eigenvectors_a_ij_rec = np.zeros((3,3))
for i in range(2):
    for j in range(2):
        eigenvalues_a_ij_rec[i] += Binv[i,j] * (bar_map_xy[j] - b[j])
        eigenvalues_a_ij_target_rec[i] += Binv[i,j] * (xmap_target[j] - b[j])
eigenvalues_a_ij_rec[2] = -eigenvalues_a_ij_rec[0]-eigenvalues_a_ij_rec[1]
eigenvalues_a_ij_target_rec[2] = -eigenvalues_a_ij_target_rec[0]-eigenvalues_a_ij_target_rec[1]

# -> Original matrix Aij reconstructed
Dij_rec = np.zeros((3,3))
for k in range(3):
    Dij_rec[k,k] = eigenvalues_a_ij_rec[k]
Qij_rec = eigenvectors_a_ij
Aij_rec = np.dot(Qij_rec, np.dot(Dij_rec, np.linalg.inv(Qij_rec)))

# -> Rij reconstructed
Rij_rec = Rkk * ( (1/3)*Deltaij + Aij_rec)

# ---------- Print results
print("\nReynolds stress tensor")
print("(direct)")
print(Rij)
print("(reconstructed)")
print(Rij_rec)
print("\nAnisotropy tensor")
print("(direct)")
print(Aij)
print("(reconstructed)")
print(Aij_rec)
print("\nEigen-Values:")
print("(direct)")
print(eigenvalues_a_ij)
print("(reconstructed)")
print(eigenvalues_a_ij_rec)
print("\nEigen-Vectors:")
print(eigenvectors_a_ij)
print("\nBarycentric map:")
print(bar_map_xy)

print("\n\nXmap target: ", xmap_target)
print("Eigen-values target: ", eigenvalues_a_ij_target_rec)


# ---------------------------------------------------------------
#                      Linear interpolation
# ---------------------------------------------------------------

# Visualize the values of RxxDelta at uniform grid vs. adaptative values after unif->adapt interpolation
# Values taken from a ODT simulation at a random time.

# Variable Values
RxxDeltaUnif   = np.array([-1.75513e-06, -0.00249441, -1.40113e-05, 0.000227935, -0.000420758, 0.000606892, 0.00042273, -0.000448288, 0.00024981, 0.00189233, 0.000739935, 0.000345731, 0.000907884, 0.00142348, 0.00113544, 3.98348e-05, -6.23449e-06, 0.000719178, 0.00020967, 0.000127796, 4.37766e-05, 0.000452725, 0.000102552, -0.000393078, 8.53745e-05, 0.00030941, 0.000359137, 0.000323892, 0.000197737, -5.81005e-05, -7.7731e-05, 0.000417973, 0.000788631, 0.000598735, 0.000453534, 0.000324937, 0.000200144, 8.41591e-05, 1.6085e-05, 6.07411e-06, 3.49908e-05, 0.000111742, 0.000123569, 9.14215e-05, -0.000502718, -0.000253923, 6.69508e-05, 4.44858e-05, 0.000113053, 4.33424e-05, -9.04281e-05, -0.000488385, -0.000713505, -0.00020583, 5.65405e-05, 0.000166331, 0.000176478, 0.00016694, 9.48552e-05, -3.17152e-05, -7.72563e-05, -5.91431e-05, 3.27326e-05, 0.000159552, 7.64515e-05, -2.2562e-05, -0.000173863, -0.000340919, -0.000443192, -0.000510299, -0.000558133, -0.000583504, -0.000587022, -0.000569096, -0.000536174, -0.000489813, -0.000438264, -0.00038392, -0.000324691, -0.000271895, -0.000228682, -0.000192579, -0.000158969, -0.000128014, -9.91989e-05, -7.49719e-05, -5.82022e-05, -4.73856e-05, -4.10622e-05, -3.75729e-05, -3.58126e-05, -3.52308e-05, -3.5571e-05, -3.69093e-05, -3.93522e-05, -4.30893e-05, -4.81203e-05, -5.45704e-05, -6.28554e-05, -7.24602e-05, -8.12564e-05, -8.82802e-05, -9.27499e-05, -9.54935e-05, -9.68009e-05, -0.000101352, -0.000114906, -0.000113475, -0.000105838, -9.92666e-05, -9.5714e-05, -9.59307e-05, -9.97262e-05, -0.000101937, -0.00010523, -0.000119347, -0.000136298, -0.000151596, -0.000166758, -0.000181613, -0.000196612, -0.000219576, -0.00025766, -0.000310022, -0.000380705, -0.000463985, -0.000543684, -0.000612413, -0.000664591, -0.000693927, -0.000695219, -0.000676529, -0.000652179, -0.000652318, -0.000738123, -0.000882267, -0.000890345, -0.000873126, -0.000837605, -0.000762132, -0.000653734, -0.000533752, -0.000429518, -0.000358371, -0.000337756, -0.000307297, -0.000374569, -0.000392038, -0.000381938, -0.000381435, -0.000452183, -0.000571661, -0.000597274, -0.000577281, -0.000554373, -0.000573563, -0.000508638, -0.00033752, -0.000350659, -0.000159454, 0.00011809, 0.000111236, -5.84969e-05, -7.02998e-05, 3.99482e-05, 8.57237e-05, 0.000102359, 1.41324e-05, 5.77241e-05, 4.99466e-05, -2.06177e-05, -0.000128734, -0.000551656, -0.000333114, -0.000337818, -0.000300745, -0.000358235, -0.000714575, -0.000888808, -0.00113362, -0.00103309, -0.000920521, -0.000988442, -0.000607187, -0.00133488, -0.00184179, -0.000706538, -0.000258671, -0.00134262, -0.001525, -0.00122815, -0.000775155, 0.000143487, -0.000146788, -0.000913558, -4.72658e-05, 0.00172656, 0.000351449, -0.00166875, -2.20651e-07])
RxxDeltaAdapt  = np.array([-0.000196676, -0.000593672, -0.00100567, -0.00143774, -0.00189867, -0.00226503, -0.00246237, -0.0021882, -0.00189733, -0.0015855, -0.0012467, -0.000872638, -0.000450874, -8.44542e-06, 5.33803e-05, 0.000163169, -9.76357e-05, 1.8542e-05, 0.00045664, -5.61641e-05, 0.00155079, 0.00118672, 0.000640853, 0.000460367, 0.000384011, 0.000536068, 0.000798311, 0.00106501, 0.0012441, 0.0014044, 0.00135508, 0.00128636, 0.00122772, 0.00115787, 0.00082411, 9.30441e-05, 0.000281387, 9.79994e-05, -0.000160075, 0.000301188, 0.000267642, -7.72919e-05, 0.000651045, 0.000239257, 2.04424e-05, 1.97446e-05, 8.94721e-05, 0.000116611, 0.000121168, 0.000121679, 0.000114748, 0.000106712, 9.74506e-05, -6.71301e-05, -0.00043729, -0.000413434, -0.000346318, -0.000271977, -0.000106888, 6.36021e-05, 5.25367e-05, 4.66919e-05, 5.62859e-05, 7.78529e-05, 0.000112919, 6.81074e-05, 3.23425e-05, -1.17758e-06, -3.04284e-05, -7.05468e-05, -0.000219955, -0.000547922, -8.94056e-05, 0.000173993, -9.39785e-06, 1.64563e-05, -7.67966e-05, -0.000476624, -0.000584002, -0.000532845, -0.000366827, -0.000212809, -0.000112885, -5.23658e-05, -3.67221e-05, -3.62499e-05, -4.61661e-05, -7.04515e-05, -9.28739e-05, -0.000105699, -0.000101781, -9.93975e-05, -0.000122888, -0.000174085, -0.000248767, -0.000464329, -0.000670654, -0.000673952, -0.00071253, -0.00088964, -0.000828277, -0.000632633, -0.000415443, -0.000317348, -0.000381829, -0.000508396, -0.000575283, -0.000497181, -0.000308034, 1.22622e-06, 0.000113883, 5.96822e-05, -2.86568e-05, -5.94277e-05, -6.19688e-05, -6.53217e-05, -6.88145e-05, -5.85724e-05, -4.26772e-05, -2.94633e-05, -1.44113e-05, 4.89095e-06, 2.52607e-05, 4.08367e-05, 4.85643e-05, 5.69088e-05, 6.79547e-05, 8.03878e-05, 8.73021e-05, 9.10785e-05, 9.49291e-05, 9.77416e-05, 9.96522e-05, 0.000101438, 9.34392e-05, 6.95487e-05, 3.87503e-05, 1.43637e-05, 2.24147e-05, 3.35459e-05, 4.75111e-05, 5.58088e-05, 5.13738e-05, 3.64479e-05, 1.8816e-05, 3.33742e-06, -8.74179e-06, -3.06574e-05, -6.99017e-05, -0.000100623, -0.000118244, -0.00013627, -0.000191393, -0.00026003, -0.000348602, -0.000439481, -0.000522851, -0.000526605, -0.000481205, -0.000440201, -0.000414189, -0.000388096, -0.000359737, -0.000333306, -0.000334708, -0.00033723, -0.000317864, -0.000302795, -0.000318417, -0.00033014, -0.000342007, -0.000357036, -0.000492682, -0.000667401, -0.000779244, -0.000873427, -0.00100535, -0.00111903, -0.0011028, -0.00105092, -0.000950039, -0.000981921, -0.0010826, -0.000633939, -0.00137471, -0.00137106, -0.000931727, -0.000486306, -0.000166066, 0.000134487, -1.57492e-05, -0.00026846, -0.000799042, -0.000458872, -0.000169628, 0.000105908, 0.000455487, 0.000810989, 0.00127898, 0.00137091, 0.000644264, 6.99393e-05, -0.000478148, -0.000862631, -0.00119995, -0.00154517, -0.00146765, -0.00121244, -0.000989315, -0.000782845, -0.000499119, -0.000158161])
# Sampled positions
delta          = 1
nunif          = 200
posUnif        = np.zeros(nunif)
for i in range(nunif):
    posUnif[i] = - delta + i * (2.0 * delta) / (nunif - 1)
posAdapt       = np.array([-0.999214, -0.997613, -0.995952, -0.99421, -0.992352, -0.990875, -0.98982, -0.988709, -0.98753, -0.986267, -0.984894, -0.983379, -0.98167, -0.979668, -0.9771, -0.97254, -0.964805, -0.955503, -0.941549, -0.924003, -0.911638, -0.903394, -0.896971, -0.89237, -0.888763, -0.886044, -0.881356, -0.876334, -0.872843, -0.869719, -0.86696, -0.864563, -0.862516, -0.860079, -0.856441, -0.849734, -0.835211, -0.805481, -0.773569, -0.749113, -0.724162, -0.698717, -0.67111, -0.641341, -0.618734, -0.603289, -0.590856, -0.583802, -0.57993, -0.577298, -0.575132, -0.572619, -0.569724, -0.565157, -0.558896, -0.554182, -0.551471, -0.548468, -0.543133, -0.53619, -0.53124, -0.528625, -0.525909, -0.522747, -0.517569, -0.511108, -0.506711, -0.504193, -0.501995, -0.498981, -0.494216, -0.484779, -0.462877, -0.434567, -0.408807, -0.378665, -0.343131, -0.311576, -0.285008, -0.25556, -0.22323, -0.191561, -0.160552, -0.130255, -0.10067, -0.0702782, -0.0390797, -0.00712696, 0.02558, 0.0584995, 0.0916316, 0.124758, 0.157878, 0.190887, 0.223784, 0.256325, 0.288509, 0.317646, 0.343736, 0.367246, 0.388177, 0.408803, 0.429124, 0.458788, 0.489617, 0.512266, 0.538565, 0.568512, 0.59018, 0.603808, 0.614209, 0.621143, 0.626374, 0.628933, 0.631097, 0.633952, 0.636926, 0.63926, 0.640709, 0.641914, 0.643286, 0.645045, 0.646902, 0.648436, 0.650133, 0.651965, 0.65439, 0.65712, 0.659245, 0.661527, 0.663853, 0.665552, 0.666706, 0.667785, 0.669358, 0.672079, 0.675588, 0.678366, 0.680301, 0.682868, 0.686088, 0.690917, 0.696648, 0.700415, 0.702926, 0.705131, 0.706851, 0.709476, 0.713124, 0.71598, 0.717618, 0.718772, 0.720082, 0.721713, 0.723818, 0.725978, 0.727959, 0.729795, 0.731883, 0.733769, 0.734965, 0.736165, 0.737469, 0.739103, 0.742098, 0.747488, 0.754153, 0.759152, 0.761883, 0.763933, 0.766007, 0.768635, 0.772636, 0.777564, 0.782625, 0.788058, 0.793729, 0.798396, 0.802076, 0.807263, 0.81646, 0.828181, 0.845762, 0.870976, 0.891216, 0.904709, 0.916124, 0.922758, 0.926262, 0.92955, 0.935162, 0.941293, 0.948248, 0.955024, 0.958379, 0.960667, 0.962648, 0.964662, 0.967313, 0.972449, 0.977759, 0.9813, 0.984027, 0.985939, 0.987618, 0.989335, 0.991161, 0.992698, 0.994042, 0.995286, 0.996995, 0.999049])

print("\n\nNumber of points uniform    grid: ", posUnif.size)
print("Number of points adaptative grid: ",     posAdapt.size)

plt.figure()
plt.plot(posUnif,  RxxDeltaUnif , label="unif.  grid")
plt.plot(posAdapt, RxxDeltaAdapt, label="adapt. grid")
plt.legend()
plt.show()
